<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PDF Viewer ‚Äî BTech Vault</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="firebase-config.js"></script>
</head>
<body style="overflow:hidden;">

<!-- VIEWER HEADER -->
<div class="viewer-header">
  <div style="display:flex; align-items:center; gap:1rem; flex:1; min-width:0;">
    <a href="index.html" class="btn btn-outline" style="font-size:0.8rem; flex-shrink:0;">‚Üê Back</a>
    <div style="min-width:0;">
      <div id="pdfTitle" style="font-family:'Syne',sans-serif; font-weight:700; font-size:1rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Loading...</div>
      <div id="pdfSubject" style="font-size:0.75rem; color:var(--text3); font-family:'DM Mono',monospace;"></div>
    </div>
  </div>
  <div style="display:flex; align-items:center; gap:0.75rem; flex-shrink:0;">
    <div id="pdfTags" style="display:flex; gap:0.4rem;"></div>
    <button id="saveBtn" class="btn btn-outline" style="font-size:0.8rem;" onclick="toggleSave()">üîñ Save</button>
    <div id="navUser" style="font-size:0.8rem; color:var(--text2);"></div>
  </div>
</div>

<!-- PDF LOADING STATE -->
<div id="loadingState" style="display:flex; align-items:center; justify-content:center; height:calc(100vh - 64px); flex-direction:column; gap:1rem; color:var(--text2);">
  <div class="spinner" style="width:32px; height:32px; border-width:3px;"></div>
  <p>PDF load avuthundhi...</p>
</div>

<!-- PDF IFRAME (Google Docs Viewer - no download) -->
<iframe id="pdfFrame" class="viewer-frame" style="display:none;"
  sandbox="allow-scripts allow-same-origin allow-forms"
  allowfullscreen>
</iframe>

<!-- LOGIN PROMPT for save -->
<div class="modal-overlay" id="loginModal">
  <div class="modal" style="max-width:360px; text-align:center;">
    <div style="font-size:2.5rem; margin-bottom:1rem;">üîê</div>
    <h2>Login Cheyyandi</h2>
    <p style="color:var(--text2); margin-bottom:1.5rem; font-size:0.875rem;">PDF save cheskovadam ki Google account kavali</p>
    <a href="login.html" class="btn btn-primary" style="width:100%; justify-content:center; margin-bottom:0.75rem;">Login / Sign Up</a>
    <button class="btn btn-outline" style="width:100%; justify-content:center;" onclick="closeModal()">Cancel</button>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
let currentUser = null;
let pdfId = null;
let pdfData = null;
let isSaved = false;

// ============================================
// INIT
// ============================================
const params = new URLSearchParams(window.location.search);
pdfId = params.get('id');

if (!pdfId) {
  window.location.href = 'index.html';
}

auth.onAuthStateChanged(async (user) => {
  currentUser = user;
  updateNavUser(user);
  await loadPdf();
  if (user) {
    await checkIfSaved();
  }
});

function updateNavUser(user) {
  const nav = document.getElementById('navUser');
  if (user) {
    nav.innerHTML = `
      <img src="${user.photoURL}" referrerpolicy="no-referrer" style="width:28px;height:28px;border-radius:50%;border:2px solid var(--border)"/>
    `;
  } else {
    nav.innerHTML = `<a href="login.html" class="btn btn-outline" style="font-size:0.75rem;">Login</a>`;
  }
}

// ============================================
// LOAD PDF METADATA
// ============================================
async function loadPdf() {
  try {
    const doc = await db.collection('pdfs').doc(pdfId).get();
    if (!doc.exists) {
      showError('PDF not found');
      return;
    }

    pdfData = doc.data();
    document.title = pdfData.title + ' ‚Äî BTech Vault';
    document.getElementById('pdfTitle').textContent = pdfData.title;
    document.getElementById('pdfSubject').textContent = 'üìö ' + pdfData.subject + (pdfData.branch ? ` ‚Ä¢ ${pdfData.branch}` : '') + (pdfData.year ? ` ‚Ä¢ ${pdfData.year}` : '');

    const tags = (pdfData.tags || []).slice(0, 3);
    document.getElementById('pdfTags').innerHTML = tags.map(t => `<span class="tag">${t}</span>`).join('');

    // Load PDF in Google Docs Viewer (no download option)
    const viewerUrl = `https://docs.google.com/viewer?url=${encodeURIComponent(pdfData.fileUrl)}&embedded=true&toolbar=0`;
    const frame = document.getElementById('pdfFrame');

    frame.onload = () => {
      document.getElementById('loadingState').style.display = 'none';
      frame.style.display = 'block';
    };

    frame.src = viewerUrl;

    // Fallback timeout
    setTimeout(() => {
      if (document.getElementById('loadingState').style.display !== 'none') {
        document.getElementById('loadingState').innerHTML = `
          <div style="text-align:center; padding:2rem; max-width:400px;">
            <div style="font-size:3rem; margin-bottom:1rem;">‚ö†Ô∏è</div>
            <h3 style="font-family:'Syne',sans-serif; margin-bottom:0.5rem;">PDF load kaaledu</h3>
            <p style="color:var(--text2); font-size:0.875rem;">Google Docs Viewer load avvadam delayed avuthundhi. Kasepu try cheyyandi.</p>
            <button class="btn btn-primary" style="margin-top:1rem;" onclick="retryLoad()">üîÑ Retry</button>
          </div>
        `;
      }
    }, 15000);

  } catch (err) {
    showError(err.message);
  }
}

function retryLoad() {
  if (pdfData) {
    document.getElementById('loadingState').innerHTML = `<div class="spinner" style="width:32px;height:32px;border-width:3px;"></div><p style="color:var(--text2)">Reloading...</p>`;
    const viewerUrl = `https://docs.google.com/viewer?url=${encodeURIComponent(pdfData.fileUrl)}&embedded=true&toolbar=0`;
    document.getElementById('pdfFrame').src = viewerUrl;
  }
}

function showError(msg) {
  document.getElementById('loadingState').innerHTML = `
    <div style="text-align:center;">
      <div style="font-size:3rem; margin-bottom:1rem;">‚ùå</div>
      <h3 style="font-family:'Syne',sans-serif; margin-bottom:0.5rem;">Error</h3>
      <p style="color:var(--text2);">${msg}</p>
      <a href="index.html" class="btn btn-primary" style="margin-top:1rem;">‚Üê Back to Home</a>
    </div>
  `;
}

// ============================================
// SAVE
// ============================================
async function checkIfSaved() {
  if (!currentUser || !pdfId) return;
  try {
    const doc = await db.collection('users').doc(currentUser.uid)
      .collection('savedPDFs').doc(pdfId).get();
    isSaved = doc.exists;
    updateSaveBtn();
  } catch {}
}

function updateSaveBtn() {
  const btn = document.getElementById('saveBtn');
  if (isSaved) {
    btn.innerHTML = '‚úÖ Saved';
    btn.style.color = 'var(--success)';
    btn.style.borderColor = 'var(--success)';
  } else {
    btn.innerHTML = 'üîñ Save';
    btn.style.color = '';
    btn.style.borderColor = '';
  }
}

async function toggleSave() {
  if (!currentUser) {
    document.getElementById('loginModal').classList.add('active');
    return;
  }

  const ref = db.collection('users').doc(currentUser.uid).collection('savedPDFs').doc(pdfId);

  if (isSaved) {
    await ref.delete();
    isSaved = false;
    showToast('Removed from saves', 'info');
  } else {
    await ref.set({
      savedAt: firebase.firestore.FieldValue.serverTimestamp(),
      title: pdfData.title,
      subject: pdfData.subject,
      pdfId
    });
    isSaved = true;
    showToast('Saved to your account! üéâ', 'success');
  }
  updateSaveBtn();
}

function closeModal() {
  document.getElementById('loginModal').classList.remove('active');
}

// ============================================
// UTILS
// ============================================
function showToast(msg, type = 'info') {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = `toast ${type} show`;
  setTimeout(() => toast.classList.remove('show'), 3000);
}

document.getElementById('loginModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});
</script>
</body>
</html>
