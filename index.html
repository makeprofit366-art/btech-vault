<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BTech Vault ‚Äî Study PDFs</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="firebase-config.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #f8f9fa; color: #1a1a2e; min-height: 100vh; }
    nav { background: #fff; border-bottom: 1px solid #e5e7eb; padding: 0 2rem; height: 60px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
    .logo { font-size: 1.2rem; font-weight: 700; color: #1a1a2e; text-decoration: none; }
    .logo span { color: #4f46e5; }
    .nav-right { display: flex; align-items: center; gap: 0.75rem; }
    .nav-user { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: #6b7280; }
    .nav-user img { width: 30px; height: 30px; border-radius: 50%; }
    .btn { padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; font-weight: 500; cursor: pointer; border: none; text-decoration: none; display: inline-flex; align-items: center; gap: 0.4rem; transition: all 0.15s; font-family: 'Inter', sans-serif; }
    .btn-primary { background: #4f46e5; color: #fff; }
    .btn-primary:hover { background: #4338ca; }
    .btn-outline { background: #fff; color: #374151; border: 1px solid #d1d5db; }
    .btn-outline:hover { border-color: #4f46e5; color: #4f46e5; }
    .btn-sm { padding: 0.35rem 0.75rem; font-size: 0.8rem; }
    .hero { background: #fff; border-bottom: 1px solid #e5e7eb; padding: 2.5rem 2rem; }
    .hero h1 { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.4rem; }
    .hero h1 span { color: #4f46e5; }
    .hero p { color: #6b7280; font-size: 0.95rem; }
    .hero-stats { display: flex; gap: 2rem; margin-top: 1.25rem; }
    .stat-num { font-size: 1.25rem; font-weight: 700; color: #4f46e5; }
    .stat-label { font-size: 0.75rem; color: #9ca3af; }
    .filter-bar { background: #fff; border-bottom: 1px solid #e5e7eb; padding: 1rem 2rem; display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; }
    .search-wrap { position: relative; flex: 1; min-width: 220px; }
    .search-wrap input { width: 100%; padding: 0.55rem 1rem 0.55rem 2.25rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem; outline: none; font-family: 'Inter', sans-serif; background: #f9fafb; }
    .search-wrap input:focus { border-color: #4f46e5; background: #fff; }
    .search-wrap .icon { position: absolute; left: 0.7rem; top: 50%; transform: translateY(-50%); color: #9ca3af; }
    .filter-pills { display: flex; gap: 0.4rem; flex-wrap: wrap; }
    .pill { padding: 0.3rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 500; cursor: pointer; border: 1px solid #e5e7eb; background: #f9fafb; color: #6b7280; transition: all 0.15s; }
    .pill:hover, .pill.active { background: #4f46e5; color: #fff; border-color: #4f46e5; }
    .main { padding: 1.5rem 2rem; }
    .grid-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .grid-header h2 { font-size: 1rem; font-weight: 600; color: #374151; }
    .grid-header span { font-size: 0.8rem; color: #9ca3af; }
    .pdf-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 1.25rem; transition: all 0.15s; }
    .card:hover { border-color: #4f46e5; box-shadow: 0 4px 16px rgba(79,70,229,0.1); transform: translateY(-1px); }
    .card-icon { width: 40px; height: 40px; background: #eef2ff; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-bottom: 0.85rem; }
    .card-title { font-size: 0.95rem; font-weight: 600; margin-bottom: 0.3rem; color: #111827; line-height: 1.3; }
    .card-subject { font-size: 0.8rem; color: #4f46e5; font-weight: 500; margin-bottom: 0.5rem; }
    .card-meta { font-size: 0.75rem; color: #9ca3af; margin-bottom: 0.75rem; }
    .card-tags { display: flex; flex-wrap: wrap; gap: 0.3rem; margin-bottom: 0.85rem; }
    .tag { font-size: 0.72rem; padding: 0.2rem 0.5rem; border-radius: 4px; background: #f3f4f6; color: #6b7280; border: 1px solid #e5e7eb; }
    .card-actions { display: flex; gap: 0.5rem; }
    .card-actions .btn { flex: 1; justify-content: center; }
    .empty { text-align: center; padding: 4rem 1rem; color: #9ca3af; grid-column: 1/-1; }
    .empty .e-icon { font-size: 2.5rem; margin-bottom: 0.75rem; }
    .empty h3 { font-size: 1rem; font-weight: 600; color: #6b7280; margin-bottom: 0.3rem; }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 200; display: flex; align-items: center; justify-content: center; padding: 1rem; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
    .overlay.active { opacity: 1; pointer-events: all; }
    .modal { background: #fff; border-radius: 12px; padding: 2rem; width: 100%; max-width: 380px; text-align: center; }
    .modal h2 { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.5rem; }
    .modal p { color: #6b7280; font-size: 0.875rem; margin-bottom: 1.5rem; }
    .toast { position: fixed; bottom: 1.5rem; right: 1.5rem; background: #1f2937; color: #fff; padding: 0.75rem 1.1rem; border-radius: 8px; font-size: 0.875rem; z-index: 999; transform: translateY(80px); opacity: 0; transition: all 0.3s; }
    .toast.show { transform: translateY(0); opacity: 1; }
    .spinner { width: 18px; height: 18px; border: 2px solid #e5e7eb; border-top-color: #4f46e5; border-radius: 50%; animation: spin 0.7s linear infinite; display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading { display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 3rem; color: #9ca3af; font-size: 0.875rem; grid-column: 1/-1; }
    @media (max-width: 640px) { .hero h1 { font-size: 1.35rem; } .pdf-grid { grid-template-columns: 1fr; } .main, nav, .filter-bar { padding-left: 1rem; padding-right: 1rem; } }
  </style>
</head>
<body>

<nav>
  <a href="index.html" class="logo">BTech<span>Vault</span></a>
  <div class="nav-right" id="navRight"><div class="spinner"></div></div>
</nav>

<div class="hero">
  <h1>Find Study PDFs <span>Fast</span></h1>
  <p>Supply, backlog, arrears ‚Äî all B.Tech study materials in one place. Free.</p>
  <div class="hero-stats">
    <div><div class="stat-num" id="totalPdfs">‚Äî</div><div class="stat-label">PDFs</div></div>
    <div><div class="stat-num" id="totalSubjects">‚Äî</div><div class="stat-label">Subjects</div></div>
    <div><div class="stat-num" id="totalUsers">‚Äî</div><div class="stat-label">Contributors</div></div>
  </div>
</div>

<div class="filter-bar">
  <div class="search-wrap">
    <span class="icon">üîç</span>
    <input type="text" id="searchInput" placeholder="Search by title, subject or tag..." oninput="filterPdfs()"/>
  </div>
  <div class="filter-pills" id="subjectFilters">
    <span class="pill active" onclick="filterBySubject('',this)">All</span>
  </div>
</div>

<div class="main">
  <div class="grid-header">
    <h2>All PDFs</h2>
    <span id="pdfCount"></span>
  </div>
  <div class="pdf-grid" id="pdfGrid">
    <div class="loading"><div class="spinner"></div>&nbsp;Loading PDFs...</div>
  </div>
</div>

<div class="overlay" id="loginModal">
  <div class="modal">
    <div style="font-size:2rem;margin-bottom:0.75rem">üîê</div>
    <h2>Login Required</h2>
    <p>Please login with Google to save PDFs to your account. It's free!</p>
    <a href="login.html" class="btn btn-primary" style="width:100%;justify-content:center;margin-bottom:0.5rem">Login / Sign Up</a>
    <button class="btn btn-outline" style="width:100%;justify-content:center" onclick="closeModal()">Cancel</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
let allPdfs=[], currentUser=null, savedIds=new Set(), activeSubject='';

auth.onAuthStateChanged(async(user)=>{
  currentUser=user; renderNav(user);
  if(user) await loadSaved();
  loadPdfs(); loadStats();
});

function renderNav(user){
  const nav=document.getElementById('navRight');
  if(user){
    nav.innerHTML=`<div class="nav-user"><img src="${user.photoURL}" referrerpolicy="no-referrer"/><span>${user.displayName.split(' ')[0]}</span></div><a href="dashboard.html" class="btn btn-outline btn-sm">Dashboard</a><button class="btn btn-outline btn-sm" onclick="signOut()">Logout</button>`;
  } else {
    nav.innerHTML=`<a href="login.html" class="btn btn-outline btn-sm">Login</a><a href="login.html" class="btn btn-primary btn-sm">Sign Up</a>`;
  }
}

async function loadPdfs(){
  try{
    const snap=await db.collection('pdfs').where('status','==','active').orderBy('uploadedAt','desc').get();
    allPdfs=snap.docs.map(d=>({id:d.id,...d.data()}));
    buildFilters(); renderPdfs(allPdfs);
    document.getElementById('pdfCount').textContent=allPdfs.length+' results';
  }catch(e){
    document.getElementById('pdfGrid').innerHTML=`<div class="empty"><div class="e-icon">‚ö†Ô∏è</div><h3>Could not load PDFs</h3><p>Firebase setup incomplete</p></div>`;
  }
}

async function loadStats(){
  try{
    const[pdfs,users]=await Promise.all([db.collection('pdfs').where('status','==','active').get(),db.collection('users').get()]);
    const subjects=new Set(pdfs.docs.map(d=>d.data().subject).filter(Boolean));
    document.getElementById('totalPdfs').textContent=pdfs.size;
    document.getElementById('totalSubjects').textContent=subjects.size;
    document.getElementById('totalUsers').textContent=users.size;
  }catch{}
}

async function loadSaved(){
  try{
    const snap=await db.collection('users').doc(currentUser.uid).collection('savedPDFs').get();
    savedIds=new Set(snap.docs.map(d=>d.id));
  }catch{}
}

function renderPdfs(pdfs){
  const grid=document.getElementById('pdfGrid');
  if(!pdfs.length){grid.innerHTML=`<div class="empty"><div class="e-icon">üì≠</div><h3>No PDFs found</h3><p>Try a different filter</p></div>`;return;}
  grid.innerHTML=pdfs.map(pdf=>{
    const saved=savedIds.has(pdf.id);
    const date=pdf.uploadedAt?new Date(pdf.uploadedAt.seconds*1000).toLocaleDateString('en-IN'):'';
    const tags=(pdf.tags||[]).slice(0,3);
    return`<div class="card">
      <div class="card-icon">üìÑ</div>
      <div class="card-title">${esc(pdf.title)}</div>
      <div class="card-subject">üìö ${esc(pdf.subject)}</div>
      <div class="card-meta">By ${esc(pdf.uploaderName||'Anonymous')} ¬∑ ${date}</div>
      <div class="card-tags">${tags.map(t=>`<span class="tag">${esc(t)}</span>`).join('')}</div>
      <div class="card-actions">
        <a href="viewer.html?id=${pdf.id}" class="btn btn-primary btn-sm">Open PDF</a>
        <button class="btn btn-outline btn-sm" id="sv-${pdf.id}" onclick="toggleSave('${pdf.id}',event)" style="${saved?'color:#16a34a;border-color:#16a34a;':''}">
          ${saved?'‚úÖ Saved':'üîñ Save'}
        </button>
      </div>
    </div>`;
  }).join('');
}

async function toggleSave(id,e){
  e.preventDefault();e.stopPropagation();
  if(!currentUser){document.getElementById('loginModal').classList.add('active');return;}
  const ref=db.collection('users').doc(currentUser.uid).collection('savedPDFs').doc(id);
  const btn=document.getElementById('sv-'+id);
  if(savedIds.has(id)){
    await ref.delete();savedIds.delete(id);
    btn.innerHTML='üîñ Save';btn.style.color='';btn.style.borderColor='';
    showToast('Removed from saved');
  }else{
    const pdf=allPdfs.find(p=>p.id===id);
    await ref.set({savedAt:firebase.firestore.FieldValue.serverTimestamp(),title:pdf.title,subject:pdf.subject,pdfId:id});
    savedIds.add(id);btn.innerHTML='‚úÖ Saved';btn.style.color='#16a34a';btn.style.borderColor='#16a34a';
    showToast('PDF saved! üéâ');
  }
}

function buildFilters(){
  const subjects=[...new Set(allPdfs.map(p=>p.subject).filter(Boolean))];
  const c=document.getElementById('subjectFilters');
  c.innerHTML=`<span class="pill active" onclick="filterBySubject('',this)">All</span>`+subjects.map(s=>`<span class="pill" onclick="filterBySubject('${s}',this)">${s}</span>`).join('');
}

function filterBySubject(s,el){
  document.querySelectorAll('.pill').forEach(p=>p.classList.remove('active'));
  el.classList.add('active');activeSubject=s;filterPdfs();
}

function filterPdfs(){
  const q=document.getElementById('searchInput').value.toLowerCase();
  let f=allPdfs;
  if(activeSubject)f=f.filter(p=>p.subject===activeSubject);
  if(q)f=f.filter(p=>p.title.toLowerCase().includes(q)||(p.subject||'').toLowerCase().includes(q)||(p.tags||[]).some(t=>t.toLowerCase().includes(q)));
  renderPdfs(f);document.getElementById('pdfCount').textContent=f.length+' results';
}

function closeModal(){document.getElementById('loginModal').classList.remove('active');}
document.getElementById('loginModal').addEventListener('click',e=>{if(e.target.id==='loginModal')closeModal();});
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
</script>
</body>
</html>
